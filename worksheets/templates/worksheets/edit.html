{% extends "home/layout.html" %}
{% load staticfiles %}

{% block js %}
	<script type="text/javascript" src='{% static "home/vendor/jquery-barcode/jquery-barcode.js" %}'></script>
{% endblock %}

{% block content %}	
	<span class="page-title">WORKSHEET</span>		
	<div class="panel panel-default" style="overflow-y:auto">
		<div class="panel-body">
			<div class="worksheet" id="content" >

			{% include "worksheets/_worksheet_details.html" %}
				<br>
				<form action="{% url 'worksheets:edit' worksheet.pk %}" method="post" role="form">
				{% if worksheet.machine_type == 'C' %}
					<table class="table table-striped table-condensed table-bordered samples-table" id="samples-table" >
						<thead>	
							<tr>
								<th>Location ID</th>
								<th>Form</th>
								<th>ART Number</th>
								<th>Instrument/Tube ID</th>
								<th>Rack ID</th>
								<th>...</th>
							</tr>
						</thead>
						<tbody>
							{% for s in worksheet_samples %}
							{% if forloop.counter0|divisibleby:5 %}
							<tr><td colspan='6' style='border-bottom: solid 1px;'>&nbsp;</td></tr>
							{% endif %}

							<tr>
								<td>{{ s.sample.locator_category }}{{ s.sample.envelope.envelope_number }}/{{ s.sample.locator_position }}</td>
								<td>{{ s.sample.form_number }}</td>
								<td>{{ s.sample.patient.hep_number }}</td>							
								<td>
									<input id="instrument{{ forloop.counter0 }}" type="text" name="instrument_id" value="{{ s.instrument_id }}">
									<input id="pk{{ forloop.counter0 }}" type="hidden" name="pk" value="{{ s.pk }}">
								</td>
								{% if forloop.counter0|divisibleby:5 %}
								<td rowspan="5" >						
									<input id="rack{{ forloop.counter0 }}" type="text" name="rack_id" value="{{ s.rack_id|default:"" }}">
								</td>
								<td rowspan="5" >									
									<span class="btn btn-danger btn-xs update" index="{{ forloop.counter0 }}">Update</span>	
									<br><br>
									<span style="display:none" id="saved{{ forloop.counter0 }}" class="status alert alert-success vl-alert" role="alert">saved&nbsp;<span class='x' >x</span></span>
								</td>
								{% endif %}
							</tr>

							{% endfor %}
						</tbody>
					</table>
				{% else %}
				
				<div class="row wk-row">
					<div class="col-xs-1 vlbarcodes-wrapper">
						1<br>
						Negative Control<br>
						NC							
					</div>
					<div class="col-xs-1 vlbarcodes-wrapper">
						2<br>
						Positive Control<br>
						PC
					</div>
					<div class="col-xs-1 vlbarcodes-wrapper">
						3<br>
						HPC
					</div>

					{% if worksheet.include_calibrators %}
						{% for i in "xxxxxxxx" %}
							{% with runner=forloop.counter|add:3 %}
							<div class="col-xs-1 vlbarcodes-wrapper">
								{{ runner }}<br>
								Calibrator
							</div>
							{% if runner|divisibleby:6 %}</div><div class="row">{% endif %}
							{% endwith%}
						{% endfor %}
					{% endif %}

					{% for s in worksheet_samples %}
						{% with runner=forloop.counter|add:sample_pads %}
						<div class="col-xs-1 vlbarcodes-wrapper">
							{{ runner }}<br>
							<span class='sm-label'>Pat ART #</span>: {{ s.sample.patient.hep_number }}<br>
							<span class='sm-label'>Sample ID</span>: {{ s.sample.vl_sample_id }}<br>
							<span class='sm-label'>Location ID</span>: 
							{{ s.sample.locator_category }}{{ s.sample.envelope.envelope_number }}/{{ s.sample.locator_position }}<br>
							<span class='sm-label'>Form #</span>: {{ s.sample.form_number }}

							<div class="vlbarcodes" value="{{ s.sample.vl_sample_id }}"></div>
						</div>
						{% if runner|divisibleby:6 %}</div><div class="row wk-row">{% endif %}
						{% endwith %}
						
					{% endfor %}
				</div>

				{% endif %}
			</form>
			</div>
			<br>
			<!-- <a class="btn btn-danger" href="javascript:windPop('{% url 'worksheets:pdf' worksheet.id %}')">Download as PDF</a> -->
			<a class="btn btn-danger" href="javascript:windPop('{% url 'worksheets:vlprint' worksheet.id %}')">Print</a>
			<a class="btn btn-danger" href="javascript:windPop('/worksheets/barcodes/{{ worksheet.pk }}/')">Print Barcodes</a>
			<a class="btn btn-danger" href="javascript:windPop('/worksheets/barcodes/{{ worksheet.pk }}/?multiple=1')">Print Barcodes (4 per row)</a>
		</div>
	</div>
	<script type="text/javascript">
	 $(function() {
	 	 $(".x").on("click", function(){
		 	$(this).parent().hide();
		 });
		$(".vlbarcodes").each(function (index){
            var val = $(this).attr("value");
            $(this).barcode(val, "code128",{showHRI: false,posX: 4});
        });

        $(".update").click(function(){
        	//alert("we are saving from row"+$(this).attr('index'));
        	var index = $(this).attr('index');
        	var params = {};
        	params.csrfmiddlewaretoken = "{{ csrf_token }}";
        	params.rack_id = $("#rack"+index).val();
        	var x = 1;
        	for (var i = index; i < index+5; i++) {
        		if(x==1){
        			params.instrument1 = $("#instrument"+i).val();
        			params.pk1 = $("#pk"+i).val();
        		}else if(x==2){
        			params.instrument2 = $("#instrument"+i).val();
        			params.pk2 = $("#pk"+i).val();
        		}else if(x==3){
        			params.instrument3 = $("#instrument"+i).val();
        			params.pk3 = $("#pk"+i).val();
        		}else if(x==4){
        			params.instrument4 = $("#instrument"+i).val();
        			params.pk4 = $("#pk"+i).val();
        		}else if(x==5){
        			params.instrument5 = $("#instrument"+i).val();
        			params.pk5 = $("#pk"+i).val();
        		}        		
        		x++;
        		// params.pk+i = $("#pk"+i).val();
        	};
        	//console.log(params);
        	$.post("/worksheets/edit/{{ worksheet.pk }}/", params).done(function(data) {
		 		$("#saved"+index).show();	    
			  });
	        });
    

      });
	</script>

	<style type="text/css">
	td{
		vertical-align: center;
	}
	</style>
{% endblock %}