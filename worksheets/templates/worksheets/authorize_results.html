{% extends "home/layout.html" %}
{% load staticfiles %}

{% block css %}
	<link rel="stylesheet" href='{% static "home/vendor/datatables/media/css/dataTables.jqueryui.min.css" %}'>
{% endblock %}

{% block js %}
	<script type="text/javascript" src='{% static "home/vendor/jquery-barcode/jquery-barcode.js" %}'></script>
	<script type="text/javascript" src='{% static "home/vendor/datatables/media/js/jquery.dataTables.js" %}'></script>
{% endblock %}

{% block content %}	
	<span class="page-title">WORKSHEET</span>
	<form action="/worksheets/authorize_results/{{ worksheet.pk }}/" method="post" role="form">	
	{% csrf_token %}	
	<div class="panel panel-default" style="overflow-y:auto">
		<div class="panel-body">
			<div class="worksheet" id="content" >
				<div class="row" >
					<div class="col-md-4">Worksheet Ref Number: <u>{{ worksheet.worksheet_reference_number }}</u></div>
					<div class="col-md-4">Machine Type: <u>{{ worksheet.get_machine_type_display }}</u></div>
					<div class="col-md-4">Sample Type: <u>{{ worksheet.get_sample_type_display }}</u></div>
				</div>
				<br>
				<table class="table table-striped table-condensed table-bordered" id="samples-table" >
					<thead>
						<th>#</th>
						<th>Sample&nbsp;ID</th>
						<th>Location&nbsp;ID&nbsp;&nbsp;</th>
						<th>Form</th>
						<th>ART&nbsp;Number</th>
						{% if worksheet.machine_type == 'C' %}<th>Instrument&nbsp;ID</th>{% endif %}
						<th>&nbsp;</th>
						<th>Machine Result&nbsp;(latest)</th>
						<th>Result (latest)</th>
		                <th>Suppressed?</th>
		                <th style="width:250px">Choose</th>
		                <td/>
					</thead>
					<tbody>
						{% for sample in worksheet.samples.all %}
						
						<tr {% if sample.result.repeat_test == 3 or sample.result.repeat_test == 1 or sample.result.repeat_test == 0 %} style = "background:#F5A9A9;" {% endif %} {% if sample.result.pk == '' %} style = "background:#d7af0d;" {% endif %}>
							<td>{{ forloop.counter }} </td>
							<td>{{ sample.vl_sample_id }}</td>
							<td>{{ sample.locator_category }}{{ sample.envelope.envelope_number }}/{{ sample.locator_position }}</td>
							<td>{{ sample.form_number }}</td>
							<td>{{ sample.patient.hep_number }}</td>
							{% if worksheet.machine_type == 'C' %}
							<td>{{ sample.worksheetsample_set.first.instrument_id }}</td>
							{% endif %}

							<td>
								<span id="results_list{{ forloop.counter }}" style="display:none">
								<table  class="table table-bordered table-condensed table-striped" >
									<tr><td>Result 1:</td><td>{{ sample.result.result1 }}</td></tr>
									<tr><td>Result 2:</td><td>{{ sample.result.result2 }}</td></tr>
									<tr><td>Result 3:</td><td>{{ sample.result.result3 }}</td></tr>
									<tr><td>Result 4:</td><td>{{ sample.result.result4 }}</td></tr>
									<tr><td>Result 5:</td><td>{{ sample.result.result5 }}</td></tr>
								</table>
								</span>
								
								<a href="#" class="results_list glyphicon glyphicon-list-alt" data-toggle="modal" data-target="#myModal" style="text-decoration:none;" r_id="{{ forloop.counter }}"></a>
							</td>

							<td>
								{% if sample.result.result5 %}
									{{ sample.result.result5 }}
								{% elif sample.result.result4 %}
									{{ sample.result.result4 }}
								{% elif sample.result.result3 %}
									{{ sample.result.result3 }}
								{% elif sample.result.result2 %}
									{{ sample.result.result2 }}
								{% elif sample.result.result1 %}
									{{ sample.result.result1 }}
								{% else %}
									Missing Result
								{% endif %}
							</td>
							
							<td>{% if sample.result.pk == '' %} Missing Result {% else %} 
								{{ sample.result.result_alphanumeric }} {% endif %}</td>
							<td>{{ sample.result.get_suppressed_display }}</td>
							<td>								
								{% if sample.result.repeat_test == 2 or sample.result.repeat_test == 0 %}	
									{% if sample.result.result_alphanumeric != 'FAILED' %}							
									<label><input type='radio' required='true' name='choices{{ sample.pk }}' class='choices' sample-pk="{{ sample.pk }}" value='release' {% if sample.result.authorised == 1 and sample.result.result_alphanumeric != 'FAILED' %} checked {% endif %}> Authorize</label>
									{% endif %}
								{% endif %}
								<label>
									<input type='radio' required='true'  name='choices{{ sample.pk }}' class='choices' sample-pk="{{ sample.pk }}" value='reschedule' {% if sample.result.repeat_test == 1 %} checked {% endif %}>{% if sample.result.pk == '' %}Invalidate&nbsp;&#38;&nbsp;Reschedule
									{% else %}
										Reschedule
									{% endif %}

								</label>
								<label>
									<input type='radio' required='true' name='choices{{ sample.pk }}' class='choices' sample-pk="{{ sample.pk }}" value='invalid' {% if sample.result.authorised == 1 and sample.result.result_alphanumeric == 'FAILED' %} checked {% endif %}>{% if sample.result.pk == '' %}Invalidate&nbsp;&#38;&nbsp;Authorize
									{% else %}
										Invalid
									{% endif %}
									
								</label>								
							</td>
							<td><span id="saved{{ sample.pk }}" class="status alert alert-success vl-alert" role="alert">saved&nbsp;</span></td>
						</tr>
						
						{% endfor %}
					</tbody>
				</table>
				<input type="hidden" name="push_worksheet" value='1'>
				<input type='submit' value='Save and push to next stage' class='btn btn-sm btn-danger'><br><br><br>
			</div>
		</div>
	</div>
</form>

<!-- Modal -->
<div id="myModal" class="modal fade" role="dialog">
  <div class="modal-dialog">

    <!-- Modal content-->
    <div class="modal-content">
      <div class="modal-header">
        <button type="button" class="close" data-dismiss="modal">&times;</button>
        <h4 class="modal-title">Results list for the sample</h4>
      </div>
      <div class="modal-body">
        <p id="results_list_show"></p>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-default" data-dismiss="modal">Close</button>
      </div>
    </div>

  </div>
</div>
	<script type="text/javascript">
	 $(function() {
	 	var oTable = $('#samples-table').dataTable({
			"processing": true,
			"paging":false,
			"order": [[ 2, "asc" ]],
		});

        $(".status").hide();
        //$(".missing_results").hide();
      });

	 $(".choices").on("click",function(){
	 	var params = {csrfmiddlewaretoken:"{{ csrf_token }}", sample_pk:$(this).attr('sample-pk'), choice:$(this).val()};
	 	
	 	$.post("/worksheets/authorize_results/{{ worksheet.pk }}/", params).done(function(data) {
	 		$("#saved"+params.sample_pk).show();
	 		// if(data=='completed'){
	 			//alert(data);
	 		// }		    
		  });
	 	

	 // 	$("#success").on("click", function(){
		// 	$("#success").slideUp("slow");
		// });
	 	//alert($(this).val());

	 });

	 

	 $(".x").on("click", function(){
	 	$(this).parent().hide();
	 });

	 
	$(".results_list").click(function(){
		var r_id = $(this).attr('r_id');
		$("#results_list_show").html($("#results_list"+r_id).html());
	});

	</script>

	<style type="text/css">
	.missing_results{
		background-color: #F5A9A9;
	}
	</style>

{% endblock %}