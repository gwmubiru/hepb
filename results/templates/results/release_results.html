{% extends "home/layout.html" %}
{% load staticfiles %}

{% block css %}
	<link rel="stylesheet" href='{% static "home/vendor/datatables/media/css/dataTables.jqueryui.min.css" %}'>
{% endblock %}

{% block js %}
	<script type="text/javascript" src='{% static "home/vendor/jquery-barcode/jquery-barcode.js" %}'></script>
	<script type="text/javascript" src='{% static "home/vendor/datatables/media/js/jquery.dataTables.js" %}'></script>
{% endblock %}

{% block content %}	
	<span class="page-title">WORKSHEET</span>		
	<div class="panel panel-default" style="overflow-y:auto">
		<div class="panel-body">
			<form action="/results/release_results/{{ worksheet.pk }}/" method="post" role="form">	
			{% csrf_token %}	
			<div class="worksheet" id="content" >
				<div class="row" >
					<div class="col-md-4">Worksheet Ref Number: <u>{{ worksheet.worksheet_reference_number }}</u></div>
					<div class="col-md-4">Machine Type: <u>{{ worksheet.get_machine_type_display }}</u></div>
					<div class="col-md-4">Sample Type: <u>{{ worksheet.get_sample_type_display }}</u></div>
				</div>
				<br>
				<table class="table table-striped table-condensed table-bordered" id="samples-table" >
					<thead>
						<th>Location&nbsp;ID&nbsp;&nbsp;&nbsp;</th>
		                <th width="1%">Form Number</th>
		                <th>Facility</th>
		                <th>District</th>                
		                <th>Hep Number</th>
		                <th>Other ID</th>
		                <th>Gender</th>
		                <th width="1%">Date&nbsp;of collection&nbsp;&nbsp;&nbsp;</th>
		                <th width="1%">Date&nbsp;received at CHPL</th>
		                <th>Result</th>
		                <th>Choose</th>
		                <th/>
					</thead>
					<tbody>
						{% for s in worksheet.worksheetsample_set.all %}
						{% if s.sample.result.repeat_test == 2 %}						
						<tr>
							<td>{{ s.sample.locator_category }}{{ s.sample.envelope.envelope_number }}/{{ s.sample.locator_position }}</td>
							<td>{{ s.sample.form_number }}</td>
							<td>{{ s.sample.facility.facility }}</td>
							<td>{{ s.sample.facility.district.district }} </td>
							<td>{{ s.sample.patient.hep_number }}</td>
							<td>{{ s.sample.patient.other_id }}</td>
							<td>{{ s.sample.patient.get_gender_display }}</td>
							<td>{{ s.sample.date_collected | date:"Y-m-d" }}</td>
							
							<td>{{ s.sample.date_received | date:"Y-m-d" }}</td>
							<td>{{ s.sample.result.result_alphanumeric }}</td>
							
							<td>
								{% if s.sample.result.resultsqc.released == 1 %}
									Released
								{% elif s.sample.result.resultsqc.released == 0 %}
									Retained
								{% else %}
									<label><input type='radio' required='true' name='choices{{ s.sample.result.pk }}' class='choices r' result-pk="{{ s.sample.result.pk }}" value='release'> Release</label>
									<label><input type='radio' required='true' name='choices{{ s.sample.result.pk }}' class='choices' result-pk="{{ s.sample.result.pk }}" value='retain'> Retain</label>
									<div class="comments" id="comments_sect{{ s.sample.result.pk }}" >
									<input type="text"  name='comments{{ s.sample.result.pk }}' placeholder="comments" id="comment{{ s.sample.result.pk }}" class="comments_input" result-pk="{{ s.sample.result.pk }}" value="">
									<!-- <span class="btn btn-primary btn-xs comments_save" result-pk="{{ s.sample.result.pk }}">save</span> -->
									</div>
								{% endif %}
							</td>
							<td><span id="saved{{ s.sample.result.pk }}" class="status alert alert-success vl-alert" role="alert">saved&nbsp;</span></td>
						</tr>
						{% endif %}
						
						{% endfor %}
					</tbody>
				</table>
				<input type="hidden" name="push_worksheet" value='1'>
				<input type='submit' value='Save and push to next stage' class='btn btn-sm btn-danger'><br><br><br>
			</div>
			</form>
		</div>
	</div>
	<script type="text/javascript">
	var num_pending_release = $('.r').length;
	var num_released_currently = 0;
	 $(function() {
	 	var oTable = $('#samples-table').dataTable({
			"processing": true,
			"paging":false,
			"order": [[ 0, "asc" ]],
		});
        $(".status").hide();
        $(".comments").hide();
      });

	 $(".choices").on("click",function(){
	 	var choice = $(this).val();
	 	var result_pk = $(this).attr('result-pk');
	 	if(choice == 'release'){
	 		var params = {csrfmiddlewaretoken:"{{ csrf_token }}", result_pk: result_pk, choice: choice};
	 		saveDetails(params);
	 		$('#comments_sect'+result_pk).hide();
	 	}else{
	 		$('#comments_sect'+result_pk).show();
	 	} 	

	 });

	 $(".comments_input").on("change", function(){
	 	var result_pk = $(this).attr('result-pk');
	 	var comments = $("#comment"+result_pk).val();
	 	var params = {csrfmiddlewaretoken:"{{ csrf_token }}", result_pk: result_pk, choice: 'retain', comments:comments};
	 	saveDetails(params);
	 });

	 saveDetails = function(params){
	 	num_released_currently = num_released_currently+1;
	 	if(num_released_currently == num_pending_release){
	 		params.completed = 'yes';
	 	}
	 	$.post("/results/release_results/{{ worksheet.pk }}/", params).done(function( data ) {
		    $("#saved"+params.result_pk).show();
		  });
	 }
	 $(".x").on("click", function(){
	 	$(this).parent().hide();
	 });
	</script>

{% endblock %}